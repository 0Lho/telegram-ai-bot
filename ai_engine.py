"""
–£–ú–ù–´–ô TELEGRAM –ë–û–¢ –° –ò–ò, –ö–û–¢–û–†–´–ô –†–ï–®–ê–ï–¢ –ó–ê–î–ê–ß–ò
"""

import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application, CommandHandler, MessageHandler,
    CallbackQueryHandler, ContextTypes, filters
)

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –£–ú–ù–´–ô –ò–ò
from ai_engine import ai_engine

# ===== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø =====
TOKEN = "8529839070:AAGnIAZpogj-KDUlsDSZONqPupYgu4U2Yd0"

# ===== –õ–û–ì–ò–†–û–í–ê–ù–ò–ï =====
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)

# ===== –ö–û–ú–ê–ù–î–´ –ë–û–¢–ê =====
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /start"""
    user = update.effective_user
    stats = ai_engine.get_stats()
    
    welcome_text = f"""
üöÄ **–ü–†–ò–í–ï–¢, {user.first_name}!**

–Ø ‚Äî **–£–ú–ù–´–ô –ò–ò-–ü–û–ú–û–©–ù–ò–ö**, –∫–æ—Ç–æ—Ä—ã–π –†–ï–®–ê–ï–¢ –†–ï–ê–õ–¨–ù–´–ï –ó–ê–î–ê–ß–ò!

üéØ **–Ø –ú–û–ì–£ –†–ï–®–ò–¢–¨:**

üßÆ **–ú–ê–¢–ï–ú–ê–¢–ò–ö–ê:**
‚Ä¢ –£—Ä–∞–≤–Ω–µ–Ω–∏—è –∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è
‚Ä¢ –ü—Ä–∏–º–µ—Ä—ã: 2+2*2, –∏–Ω—Ç–µ–≥—Ä–∞–ª—ã, –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–µ
‚Ä¢ –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ: "—Å–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç 15% –æ—Ç 200"

üîç **–ü–û–ò–°–ö –í –ò–ù–¢–ï–†–ù–ï–¢–ï:**
‚Ä¢ –ù–∞–π–¥—É –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
‚Ä¢ –û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã
‚Ä¢ –§–∞–∫—Ç—ã –∏ –¥–∞–Ω–Ω—ã–µ

üíª **–ü–†–û–ì–†–ê–ú–ú–ò–†–û–í–ê–ù–ò–ï:**
‚Ä¢ –ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞ –Ω–∞ Python
‚Ä¢ –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤
‚Ä¢ –ü–æ–º–æ—â—å —Å –æ—à–∏–±–∫–∞–º–∏

üßÆ **–í–´–ß–ò–°–õ–ï–ù–ò–Ø:**
‚Ä¢ –ü–æ–¥—Å—á–µ—Ç—ã –∏ —Ä–∞—Å—á–µ—Ç—ã
‚Ä¢ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
‚Ä¢ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

üìä **–ú–û–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:**
‚Ä¢ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞–ø—Ä–æ—Å–æ–≤: `{stats['queries']}`
‚Ä¢ –†–µ—à–µ–Ω–æ –∑–∞–¥–∞—á: `{stats['solved_math']}`
‚Ä¢ –ü–æ–∏—Å–∫–æ–≤: `{stats['web_searches']}`
‚Ä¢ –ê–Ω–∞–ª–∏–∑–æ–≤ –∫–æ–¥–∞: `{stats['code_analysis']}`

üõ† **–ö–û–ú–ê–ù–î–´:**
`/help` ‚Äî —á—Ç–æ —è —É–º–µ—é
`/examples` ‚Äî –ø—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤
`/stats` ‚Äî –º–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

üí° **–ü–†–û–°–¢–û –ù–ê–ü–ò–®–ò–¢–ï –í–û–ü–†–û–° ‚Äî –Ø –†–ï–®–£!**
    """
    
    keyboard = [
        [
            InlineKeyboardButton("üßÆ –ü—Ä–∏–º–µ—Ä—ã –∑–∞–¥–∞—á", callback_data="examples"),
            InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="stats")
        ],
        [
            InlineKeyboardButton("üîç –í–µ–±-–ø–æ–∏—Å–∫", callback_data="search"),
            InlineKeyboardButton("üíª –ö–æ–¥", callback_data="code")
        ],
        [
            InlineKeyboardButton("üÜò –ü–æ–º–æ—â—å", callback_data="help"),
            InlineKeyboardButton("üéØ –¢–µ—Å—Ç", callback_data="test")
        ]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(welcome_text, parse_mode='Markdown', reply_markup=reply_markup)

async def help_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /help"""
    help_text = """
üÜò **–ö–ê–ö –ü–û–õ–¨–ó–û–í–ê–¢–¨–°–Ø –ò–ò:**

üéØ **–î–õ–Ø –†–ï–®–ï–ù–ò–Ø –ó–ê–î–ê–ß –ü–†–û–°–¢–û –ù–ê–ü–ò–®–ò–¢–ï:**

üßÆ **–ú–ê–¢–ï–ú–ê–¢–ò–ö–ê:**
‚Ä¢ "—Å–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç 2+2*2"
‚Ä¢ "—Ä–µ—à–∏ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ x^2 - 5x + 6 = 0"
‚Ä¢ "15% –æ—Ç 200"
‚Ä¢ "–∫–æ—Ä–µ–Ω—å –∏–∑ 144"

üîç **–ü–û–ò–°–ö –ò–ù–§–û–†–ú–ê–¶–ò–ò:**
‚Ä¢ "–Ω–∞–π–¥–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –ò–ò"
‚Ä¢ "—á—Ç–æ —Ç–∞–∫–æ–µ Python"
‚Ä¢ "–∫—Ç–æ —Å–æ–∑–¥–∞–ª Telegram"
‚Ä¢ "–ø–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π"

üíª **–ü–†–û–ì–†–ê–ú–ú–ò–†–û–í–ê–ù–ò–ï:**
‚Ä¢ "python hello world –ø—Ä–∏–º–µ—Ä"
‚Ä¢ "–∫–∞–∫ –Ω–∞–ø–∏—Å–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –Ω–∞ Python"
‚Ä¢ "–ø—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –¥–ª—è —Ü–∏–∫–ª–∞ for"
‚Ä¢ "–æ—à–∏–±–∫–∞ Python syntax error"

üßÆ **–í–´–ß–ò–°–õ–ï–ù–ò–Ø:**
‚Ä¢ "—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –≤ –≥–æ–¥—É"
‚Ä¢ "—Ü–µ–Ω–∞ 5 —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ 150 —Ä—É–±–ª–µ–π"
‚Ä¢ "—Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É 2025 –∏ 1990"
‚Ä¢ "—Å—Ä–µ–¥–Ω–µ–µ 10, 20, 30"

üìö **–ö–û–ú–ê–ù–î–´:**
‚Ä¢ `/examples` ‚Äî –±–æ–ª—å—à–µ –ø—Ä–∏–º–µ—Ä–æ–≤
‚Ä¢ `/stats` ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç—ã
‚Ä¢ `/start` ‚Äî –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ

üöÄ **–Ø –ù–ï –ü–†–û–°–¢–û –û–¢–í–ï–ß–ê–Æ ‚Äî –Ø –†–ï–®–ê–Æ –ó–ê–î–ê–ß–ò!**
    """
    
    await update.message.reply_text(help_text, parse_mode='Markdown')

async def examples(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /examples"""
    examples_text = """
üéØ **–ü–†–ò–ú–ï–†–´ –ó–ê–ü–†–û–°–û–í –î–õ–Ø –ò–ò:**

üßÆ **–ú–ê–¢–ï–ú–ê–¢–ò–ß–ï–°–ö–ò–ï:**
1. `—Å–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç 15 + 27 * 3`
2. `—Ä–µ—à–∏ 2x + 5 = 15`
3. `–ø–ª–æ—â–∞–¥—å –∫—Ä—É–≥–∞ —Ä–∞–¥–∏—É—Å–æ–º 7`
4. `—Å–∏–Ω—É—Å 30 –≥—Ä–∞–¥—É—Å–æ–≤`

üîç **–ü–û–ò–°–ö–û–í–´–ï:**
1. `–Ω–∞–π–¥–∏ —á—Ç–æ —Ç–∞–∫–æ–µ –º–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ`
2. `–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–ø–∞–Ω–∏–∏ Apple`
3. `–∫—Ç–æ –∏–∑–æ–±—Ä–µ–ª —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ`
4. `–ø–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ –∫–æ—Å–º–æ—Å–∞`

üíª **–ü–†–û–ì–†–ê–ú–ú–ò–†–û–í–ê–ù–ò–ï:**
1. `–ø—Ä–∏–º–µ—Ä –∫–æ–¥–∞ Python –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Å–ø–∏—Å–∫–∞`
2. `–∫–∞–∫ —Å–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –≤ JavaScript`
3. `–æ—à–∏–±–∫–∞ IndexError –≤ Python`
4. `–∞–ª–≥–æ—Ä–∏—Ç–º –±–∏–Ω–∞—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞`

üßÆ **–†–ê–°–ß–ï–¢–´:**
1. `—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç 3 –∫–≥ —è–±–ª–æ–∫ –ø–æ 120 —Ä—É–±`
2. `—Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –∑–∞ 2 —á–∞—Å–∞ —Å–æ —Å–∫–æ—Ä–æ—Å—Ç—å—é 60 –∫–º/—á`
3. `—Å–∫–∏–¥–∫–∞ 20% –Ω–∞ —Ç–æ–≤–∞—Ä –∑–∞ 1000 —Ä—É–±`
4. `—Å—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª: 4, 5, 3, 4`

üéØ **–ü–†–û–°–¢–û –°–ö–û–ü–ò–†–£–ô–¢–ï –ò –í–°–¢–ê–í–¨–¢–ï –õ–Æ–ë–û–ô –ü–†–ò–ú–ï–†!**
    """
    
    await update.message.reply_text(examples_text, parse_mode='Markdown')

async def stats(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /stats"""
    stats = ai_engine.get_stats()
    
    stats_text = f"""
üìä **–°–¢–ê–¢–ò–°–¢–ò–ö–ê –†–ê–ë–û–¢–´ –ò–ò:**

‚úÖ **–í–´–ü–û–õ–ù–ï–ù–û:**
‚Ä¢ –í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤: `{stats['queries']}`
‚Ä¢ –†–µ—à–µ–Ω–æ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á: `{stats['solved_math']}`
‚Ä¢ –í—ã–ø–æ–ª–Ω–µ–Ω–æ –ø–æ–∏—Å–∫–æ–≤: `{stats['web_searches']}`
‚Ä¢ –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –∫–æ–¥–∞: `{stats['code_analysis']}`
‚Ä¢ –í –∫—ç—à–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: `{stats['cache_size']}`

üöÄ **–≠–§–§–ï–ö–¢–ò–í–ù–û–°–¢–¨:**
‚Ä¢ –ò–ò —Ä–µ—à–∞–µ—Ç –∑–∞–¥–∞—á–∏ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–µ–±-–ø–æ–∏—Å–∫ –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
‚Ä¢ –ó–∞–ø–æ–º–∏–Ω–∞–µ—Ç —á–∞—Å—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã
‚Ä¢ –£–ª—É—á—à–∞–µ—Ç—Å—è —Å –∫–∞–∂–¥—ã–º –≤–æ–ø—Ä–æ—Å–æ–º

üí° **–ò–ò –†–ê–ë–û–¢–ê–ï–¢ –ò –†–ï–®–ê–ï–¢ –†–ï–ê–õ–¨–ù–´–ï –ó–ê–î–ê–ß–ò!**
    """
    
    await update.message.reply_text(stats_text, parse_mode='Markdown')

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –í–°–ï–• —Å–æ–æ–±—â–µ–Ω–∏–π - –ò–ò –†–ï–®–ê–ï–¢ –ó–ê–î–ê–ß–ò"""
    user_text = update.message.text
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "–ò–ò —Ä–µ—à–∞–µ—Ç –∑–∞–¥–∞—á—É"
    await update.message.chat.send_action(action="typing")
    
    # –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å
    print(f"üì• –ó–∞–ø—Ä–æ—Å –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_text}")
    
    # –ü–†–û–¶–ï–°–°–ò–ú –ó–ê–ü–†–û–° –ß–ï–†–ï–ó –£–ú–ù–´–ô –ò–ò
    result = ai_engine.process_query(user_text)
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
    if result.get("success", False):
        answer = result["answer"]
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–∏–ø —Ä–µ—à–µ–Ω–∏—è
        task_type = result.get("type", "–æ–±—â–µ–µ")
        type_icons = {
            "math": "üßÆ",
            "search": "üîç", 
            "code": "üíª",
            "calculation": "üßÆ",
            "general": "üí°"
        }
        
        icon = type_icons.get(task_type, "üí°")
        answer = f"{icon} **{task_type.upper()}**\n\n{answer}"
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
        if result.get("source"):
            answer += f"\n\nüìö –ò—Å—Ç–æ—á–Ω–∏–∫: {result['source']}"
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—è—Å–Ω–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
        if result.get("explanation"):
            answer += f"\n\nüìù –ü–æ—è—Å–Ω–µ–Ω–∏–µ: {result['explanation']}"
    
    else:
        answer = "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∏–Ω–∞—á–µ."
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –û–¢–í–ï–¢
    await update.message.reply_text(answer, parse_mode='Markdown')
    
    # –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
    print(f"üì§ –û—Ç–≤–µ—Ç –ò–ò: {answer[:100]}...")

async def button_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫"""
    query = update.callback_query
    await query.answer()
    
    data = query.data
    
    if data == "examples":
        examples_text = """
üßÆ **–ë—ã—Å—Ç—Ä—ã–µ –ø—Ä–∏–º–µ—Ä—ã:**
1. `2+2*2` ‚Äî –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞
2. `—á—Ç–æ —Ç–∞–∫–æ–µ –ò–ò` ‚Äî –ø–æ–∏—Å–∫
3. `python –ø—Ä–∏–º–µ—Ä –∫–æ–¥–∞` ‚Äî –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ
4. `—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –≤ –Ω–µ–¥–µ–ª–µ` ‚Äî –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ
        
**–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –ª—é–±–æ–π –ø—Ä–∏–º–µ—Ä!**
        """
        await query.edit_message_text(examples_text, parse_mode='Markdown')
    
    elif data == "stats":
        stats = ai_engine.get_stats()
        text = f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n"
        text += f"‚Ä¢ –ó–∞–ø—Ä–æ—Å–æ–≤: {stats['queries']}\n"
        text += f"‚Ä¢ –†–µ—à–µ–Ω–æ –∑–∞–¥–∞—á: {stats['solved_math']}\n"
        text += f"‚Ä¢ –ü–æ–∏—Å–∫–æ–≤: {stats['web_searches']}\n"
        text += f"‚Ä¢ –ê–Ω–∞–ª–∏–∑–æ–≤ –∫–æ–¥–∞: {stats['code_analysis']}"
        await query.edit_message_text(text)
    
    elif data == "help":
        await query.edit_message_text(
            "üÜò –ù–∞–ø–∏—à–∏—Ç–µ:\n"
            "‚Ä¢ –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫—É—é –∑–∞–¥–∞—á—É\n"
            "‚Ä¢ –í–æ–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞\n"
            "‚Ä¢ –ó–∞–ø—Ä–æ—Å –ø–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—é\n"
            "‚Ä¢ –õ—é–±–æ–π —Ä–∞—Å—á–µ—Ç\n\n"
            "–Ø –†–ï–®–£!",
            parse_mode='Markdown'
        )
    
    elif data == "search":
        await query.edit_message_text(
            "üîç –î–ª—è –ø–æ–∏—Å–∫–∞ –Ω–∞–ø–∏—à–∏—Ç–µ:\n"
            "‚Ä¢ '–Ω–∞–π–¥–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ ...'\n"
            "‚Ä¢ '—á—Ç–æ —Ç–∞–∫–æ–µ ...'\n"
            "‚Ä¢ '–∫—Ç–æ —Ç–∞–∫–æ–π ...'\n"
            "‚Ä¢ '–ø–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ ...'\n\n"
            "–Ø –Ω–∞–π–¥—É –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ!",
            parse_mode='Markdown'
        )
    
    elif data == "code":
        await query.edit_message_text(
            "üíª –î–ª—è –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è:\n"
            "‚Ä¢ 'python –ø—Ä–∏–º–µ—Ä —Ñ—É–Ω–∫—Ü–∏–∏'\n"
            "‚Ä¢ '–∫–∞–∫ –Ω–∞–ø–∏—Å–∞—Ç—å —Ü–∏–∫–ª'\n"
            "‚Ä¢ '–æ—à–∏–±–∫–∞ –≤ –∫–æ–¥–µ'\n"
            "‚Ä¢ '–∞–ª–≥–æ—Ä–∏—Ç–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏'\n\n"
            "–ü–æ–º–æ–≥—É —Å –∫–æ–¥–æ–º!",
            parse_mode='Markdown'
        )
    
    elif data == "test":
        # –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
        test_query = "—Å–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç 15% –æ—Ç 200"
        result = ai_engine.process_query(test_query)
        
        if result.get("success", False):
            await query.edit_message_text(
                f"üéØ –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å: '{test_query}'\n\n"
                f"‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç: {result['answer']}",
                parse_mode='Markdown'
            )
        else:
            await query.edit_message_text("‚ùå –¢–µ—Å—Ç –Ω–µ —É–¥–∞–ª—Å—è")

# ===== –ó–ê–ü–£–°–ö –ë–û–¢–ê =====
def main():
    """–ó–∞–ø—É—Å–∫ —É–º–Ω–æ–≥–æ –±–æ—Ç–∞"""
    print("=" * 60)
    print("ü§ñ –ó–ê–ü–£–°–ö –£–ú–ù–û–ì–û –ò–ò-–ë–û–¢–ê, –ö–û–¢–û–†–´–ô –†–ï–®–ê–ï–¢ –ó–ê–î–ê–ß–ò")
    print("=" * 60)
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
    stats = ai_engine.get_stats()
    print(f"üß† –ò–ò –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∏ –≥–æ—Ç–æ–≤ —Ä–µ—à–∞—Ç—å –∑–∞–¥–∞—á–∏")
    print(f"üìä –ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: {stats}")
    print("=" * 60)
    print("üéØ **–ò–ò –£–ú–ï–ï–¢ –†–ï–®–ê–¢–¨:**")
    print("‚Ä¢ –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ –∏ —É—Ä–∞–≤–Ω–µ–Ω–∏—è")
    print("‚Ä¢ –ò—Å–∫–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ")
    print("‚Ä¢ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è")
    print("‚Ä¢ –í—ã–ø–æ–ª–Ω—è—Ç—å –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –∏ —Ä–∞—Å—á–µ—Ç—ã")
    print("=" * 60)
    print("üì± **–ò–ù–°–¢–†–£–ö–¶–ò–Ø:**")
    print("1. –ù–∞–π–¥–∏—Ç–µ –±–æ—Ç–∞ –≤ Telegram")
    print("2. –ù–∞–ø–∏—à–∏—Ç–µ /start")
    print("3. –ó–ê–î–ê–ô–¢–ï –õ–Æ–ë–£–Æ –ó–ê–î–ê–ß–£ - –ò–ò –†–ï–®–ò–¢!")
    print("=" * 60)
    print("üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞: Ctrl + C")
    print("=" * 60)
    
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    app = Application.builder().token(TOKEN).build()
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("help", help_cmd))
    app.add_handler(CommandHandler("examples", examples))
    app.add_handler(CommandHandler("stats", stats))
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –í–°–ï–• —Å–æ–æ–±—â–µ–Ω–∏–π
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–æ–∫
    app.add_handler(CallbackQueryHandler(button_callback))
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    app.run_polling()

if __name__ == "__main__":
    main()